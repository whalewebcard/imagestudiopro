<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Media Converter & Compressor - เครื่องมือจัดการสื่อครบวงจร</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600&display=swap');
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #f1f5f9;
        }
        .drop-zone {
            border: 2px dashed #cbd5e1;
            transition: all 0.3s ease;
        }
        .drop-zone.drag-over {
            border-color: #3b82f6;
            background-color: #eff6ff;
            transform: scale(1.01);
        }
        .mode-tab.active {
            background-color: white;
            color: #2563eb;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        }
        input[type=range] {
            accent-color: #3b82f6;
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }
    </style>
</head>
<body class="min-h-screen py-6 px-4">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-800 mb-2">
                <i class="fas fa-photo-video text-blue-600 mr-2"></i>Media Hub
            </h1>
            <p class="text-slate-500">บีบอัดและเปลี่ยนนามสกุล รูปภาพ วิดีโอ และเสียง ได้ในที่เดียว</p>
        </div>

        <!-- Mode Switcher -->
        <div class="flex justify-center mb-8">
            <div class="bg-slate-200 p-1 rounded-2xl flex space-x-1 w-full max-w-md">
                <button onclick="setMode('image')" id="tab-image" class="mode-tab active flex-1 py-2 rounded-xl text-sm font-bold transition-all">
                    <i class="fas fa-image mr-1"></i> รูปภาพ
                </button>
                <button onclick="setMode('video')" id="tab-video" class="mode-tab flex-1 py-2 rounded-xl text-sm font-bold transition-all text-slate-500">
                    <i class="fas fa-video mr-1"></i> วิดีโอ
                </button>
                <button onclick="setMode('audio')" id="tab-audio" class="mode-tab flex-1 py-2 rounded-xl text-sm font-bold transition-all text-slate-500">
                    <i class="fas fa-volume-up mr-1"></i> เสียง
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl shadow-2xl overflow-hidden border border-slate-200">
            <!-- Upload Section -->
            <div id="uploadSection" class="p-10">
                <div id="dropZone" class="drop-zone rounded-2xl p-16 text-center cursor-pointer hover:border-blue-400 hover:bg-slate-50 group">
                    <input type="file" id="fileInput" class="hidden">
                    <div class="space-y-4">
                        <div id="modeIcon" class="text-6xl text-slate-300 group-hover:text-blue-500 transition-colors">
                            <i class="fas fa-images"></i>
                        </div>
                        <div>
                            <p id="dropText" class="text-xl font-semibold text-slate-700">ลากไฟล์รูปภาพมาวางที่นี่</p>
                            <p id="dropSubtext" class="text-sm text-slate-400 mt-2">ประมวลผลบนเครื่องคุณ 100% ปลอดภัยและรวดเร็ว</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Editor Section -->
            <div id="editorSection" class="hidden grid grid-cols-1 lg:grid-cols-12 divide-y lg:divide-y-0 lg:divide-x divide-slate-100">
                <!-- Preview Side (Left) -->
                <div class="lg:col-span-7 p-6 bg-slate-50/50">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-slate-700 flex items-center">
                            <i class="fas fa-play-circle mr-2 text-blue-500"></i> ตัวอย่างผลลัพธ์
                        </h3>
                        <span id="fileInfoDisplay" class="text-xs font-mono bg-white px-2 py-1 rounded border border-slate-200 text-slate-500">Ready</span>
                    </div>
                    
                    <div id="previewContainer" class="relative rounded-xl overflow-hidden bg-white aspect-video flex items-center justify-center border border-slate-200 shadow-inner">
                        <div id="loader" class="absolute inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center hidden z-10">
                            <div class="flex flex-col items-center">
                                <i class="fas fa-circle-notch fa-spin text-blue-500 text-3xl mb-2"></i>
                                <span id="loaderText" class="text-xs text-slate-600 font-medium tracking-wider">กำลังประมวลผล...</span>
                                <div id="progressBar" class="w-48 h-1.5 bg-slate-200 rounded-full mt-3 overflow-hidden">
                                    <div id="progressFill" class="h-full bg-blue-500 w-0 transition-all duration-300"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-6">
                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                            <p class="text-[10px] text-slate-400 uppercase font-bold tracking-widest mb-1">ขนาดต้นฉบับ</p>
                            <p id="originalSize" class="text-lg font-bold text-slate-600">-</p>
                        </div>
                        <div class="bg-blue-600 p-4 rounded-xl border border-blue-700 shadow-lg">
                            <p class="text-[10px] text-blue-200 uppercase font-bold tracking-widest mb-1">ขนาดผลลัพธ์ประมาณการ</p>
                            <p id="compressedSize" class="text-lg font-bold text-white">-</p>
                        </div>
                    </div>
                </div>

                <!-- Controls Side (Right) -->
                <div class="lg:col-span-5 p-6 space-y-6">
                    <h3 class="font-bold text-slate-800 flex items-center">
                        <i class="fas fa-sliders-h mr-2 text-slate-400"></i> การตั้งค่า
                    </h3>

                    <!-- Image Settings -->
                    <div id="imageSettings" class="space-y-6">
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-semibold text-slate-600">สเกลภาพ (Scale)</label>
                                <span id="scaleLabel" class="text-sm font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">100%</span>
                            </div>
                            <input type="range" id="scaleSlider" min="10" max="100" value="100" step="5" class="w-full">
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-semibold text-slate-600">คุณภาพ (Quality)</label>
                                <span id="qualityLabel" class="text-sm font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">80%</span>
                            </div>
                            <input type="range" id="qualitySlider" min="5" max="100" value="80" class="w-full">
                        </div>
                    </div>

                    <!-- Video/Audio Settings -->
                    <div id="mediaSettings" class="hidden space-y-6">
                        <div class="space-y-4">
                            <div class="flex justify-between items-center">
                                <label class="text-sm font-semibold text-slate-600">คุณภาพไฟล์ (Bitrate)</label>
                                <select id="bitrateSelect" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-medium">
                                    <option value="high">คุณภาพสูง (Bitrate สูง)</option>
                                    <option value="medium" selected>ปานกลาง (สมดุล)</option>
                                    <option value="low">ขนาดเล็ก (Bitrate ต่ำ)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Format Selector -->
                    <div class="space-y-2">
                        <label class="text-sm font-semibold text-slate-600">นามสกุลไฟล์ที่ต้องการ (Convert to)</label>
                        <select id="formatSelect" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none font-medium">
                            <!-- Injected by JS -->
                        </select>
                    </div>

                    <div class="pt-4 space-y-3">
                        <button id="downloadBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl transition duration-200 flex items-center justify-center shadow-lg active:scale-95">
                            <i class="fas fa-magic mr-2"></i> ประมวลผลและดาวน์โหลด
                        </button>
                        <button id="resetBtn" class="w-full bg-white text-slate-500 font-semibold py-3 rounded-xl hover:bg-slate-50 border border-slate-200 transition">
                            เลือกไฟล์ใหม่
                        </button>
                    </div>
                    
                    <p class="text-[11px] text-slate-400 text-center italic">
                        * รองรับการแปลง MP4 เป็น MP3 โดยตรงผ่านโหมดวิดีโอ
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-10 left-1/2 -translate-x-1/2 translate-y-20 transition-all duration-300 opacity-0 z-50">
        <div class="bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl flex items-center space-x-3">
            <i class="fas fa-info-circle text-blue-400"></i>
            <span id="toastText">ข้อความ</span>
        </div>
    </div>

    <script src="https://unpkg.com/@ffmpeg/ffmpeg@0.11.6/dist/ffmpeg.min.js"></script>

    <script>
        const { createFFmpeg, fetchFile } = FFmpeg;
        
        // Single-thread version for compatibility
        const ffmpeg = createFFmpeg({ 
            log: false,
            corePath: 'https://unpkg.com/@ffmpeg/core-st@0.11.0/dist/ffmpeg-core.js'
        });

        const el = {
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('fileInput'),
            uploadSection: document.getElementById('uploadSection'),
            editorSection: document.getElementById('editorSection'),
            previewContainer: document.getElementById('previewContainer'),
            originalSize: document.getElementById('originalSize'),
            compressedSize: document.getElementById('compressedSize'),
            qualitySlider: document.getElementById('qualitySlider'),
            qualityLabel: document.getElementById('qualityLabel'),
            scaleSlider: document.getElementById('scaleSlider'),
            scaleLabel: document.getElementById('scaleLabel'),
            formatSelect: document.getElementById('formatSelect'),
            downloadBtn: document.getElementById('downloadBtn'),
            resetBtn: document.getElementById('resetBtn'),
            fileInfoDisplay: document.getElementById('fileInfoDisplay'),
            loader: document.getElementById('loader'),
            loaderText: document.getElementById('loaderText'),
            progressFill: document.getElementById('progressFill'),
            imageSettings: document.getElementById('imageSettings'),
            mediaSettings: document.getElementById('mediaSettings'),
            bitrateSelect: document.getElementById('bitrateSelect'),
            toast: document.getElementById('toast'),
            toastText: document.getElementById('toastText'),
            modeIcon: document.getElementById('modeIcon'),
            dropText: document.getElementById('dropText')
        };

        let state = {
            mode: 'image',
            file: null,
            originalUrl: null,
            ffmpegLoaded: false
        };

        const formats = {
            image: [
                { val: 'image/jpeg', label: 'JPEG (รูปถ่าย)' },
                { val: 'image/webp', label: 'WebP (ขนาดเล็ก/ทันสมัย)' },
                { val: 'image/png', label: 'PNG (โปร่งใส)' }
            ],
            video: [
                { val: 'video/mp4', label: 'MP4 (มาตรฐาน)' },
                { val: 'video/webm', label: 'WebM (เว็บวิดีโอ)' },
                { val: 'audio/mpeg', label: 'MP3 (แยกเฉพาะเสียงจากวิดีโอ)' },
                { val: 'image/gif', label: 'GIF (ภาพเคลื่อนไหว)' }
            ],
            audio: [
                { val: 'audio/mpeg', label: 'MP3 (มาตรฐาน)' },
                { val: 'audio/wav', label: 'WAV (คุณภาพสูง)' },
                { val: 'audio/ogg', label: 'OGG (เปิดกว้าง)' }
            ]
        };

        // --- Core Functions ---

        function setMode(newMode) {
            state.mode = newMode;
            document.querySelectorAll('.mode-tab').forEach(t => {
                t.classList.remove('active', 'text-blue-600');
                t.classList.add('text-slate-500');
            });
            document.getElementById(`tab-${newMode}`).classList.add('active');
            document.getElementById(`tab-${newMode}`).classList.remove('text-slate-500');
            
            updateUploadUI();
            updateFormatSelect();
            
            el.imageSettings.classList.toggle('hidden', newMode !== 'image');
            el.mediaSettings.classList.toggle('hidden', newMode === 'image');
        }

        function updateUploadUI() {
            const icons = { image: 'fa-images', video: 'fa-video', audio: 'fa-file-audio' };
            const texts = { image: 'ลากไฟล์รูปภาพมาวางที่นี่', video: 'ลากไฟล์วิดีโอมาวางที่นี่', audio: 'ลากไฟล์เสียงมาวางที่นี่' };
            el.modeIcon.innerHTML = `<i class="fas ${icons[state.mode]}"></i>`;
            el.dropText.textContent = texts[state.mode];
        }

        function updateFormatSelect() {
            el.formatSelect.innerHTML = formats[state.mode].map(f => `<option value="${f.val}">${f.label}</option>`).join('');
        }

        // --- Events ---

        el.dropZone.onclick = () => el.fileInput.click();
        el.dropZone.ondragover = (e) => { e.preventDefault(); el.dropZone.classList.add('drag-over'); };
        el.dropZone.ondragleave = () => el.dropZone.classList.remove('drag-over');
        el.dropZone.ondrop = (e) => {
            e.preventDefault();
            el.dropZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        };

        el.fileInput.onchange = (e) => { if(e.target.files.length) handleFile(e.target.files[0]); };
        
        el.qualitySlider.oninput = (e) => {
            el.qualityLabel.textContent = `${e.target.value}%`;
            if (state.mode === 'image') processImagePreview();
        };

        el.scaleSlider.oninput = (e) => {
            el.scaleLabel.textContent = `${e.target.value}%`;
            if (state.mode === 'image') processImagePreview();
        };

        el.resetBtn.onclick = () => location.reload();

        el.downloadBtn.onclick = async () => {
            if (state.mode === 'image') {
                triggerImageDownload();
            } else {
                await processMediaWithFFmpeg();
            }
        };

        // --- Handling ---

        function handleFile(file) {
            const type = file.type.split('/')[0];
            
            // Allow Video files in Audio mode for easier conversion (Video to MP3)
            if (state.mode === 'image' && type !== 'image') return showToast('กรุณาเลือกไฟล์รูปภาพ');
            if (state.mode === 'video' && type !== 'video') return showToast('กรุณาเลือกไฟล์วิดีโอ');
            if (state.mode === 'audio' && (type !== 'audio' && type !== 'video')) return showToast('กรุณาเลือกไฟล์เสียงหรือวิดีโอ');

            state.file = file;
            el.originalSize.textContent = formatSize(file.size);
            el.uploadSection.classList.add('hidden');
            el.editorSection.classList.remove('hidden');

            const url = URL.createObjectURL(file);
            state.originalUrl = url;
            
            setupPreview(url);
            if (state.mode === 'image') processImagePreview();
        }

        function setupPreview(url) {
            el.previewContainer.innerHTML = '';
            el.previewContainer.appendChild(el.loader); 

            if (state.mode === 'image') {
                const img = document.createElement('img');
                img.id = 'previewEl';
                img.className = 'max-w-full max-h-full object-contain';
                img.src = url;
                el.previewContainer.appendChild(img);
            } else if (state.mode === 'video' || (state.mode === 'audio' && state.file.type.startsWith('video'))) {
                const video = document.createElement('video');
                video.id = 'previewEl';
                video.className = 'max-w-full max-h-full';
                video.controls = true;
                video.src = url;
                el.previewContainer.appendChild(video);
            } else {
                const audioContainer = document.createElement('div');
                audioContainer.className = 'flex flex-col items-center p-8 w-full';
                audioContainer.innerHTML = `
                    <i class="fas fa-music text-5xl text-blue-200 mb-4"></i>
                    <audio id="previewEl" controls class="w-full"></audio>
                    <p class="mt-4 text-slate-400 text-sm truncate max-w-xs">${state.file.name}</p>
                `;
                el.previewContainer.appendChild(audioContainer);
                document.getElementById('previewEl').src = url;
            }
        }

        function processImagePreview() {
            const img = new Image();
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const scale = el.scaleSlider.value / 100;
                canvas.width = img.width * scale;
                canvas.height = img.height * scale;
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                
                const quality = el.qualitySlider.value / 100;
                const format = el.formatSelect.value;
                
                canvas.toBlob((blob) => {
                    if (blob) {
                        el.compressedSize.textContent = `~ ${formatSize(blob.size)}`;
                        document.getElementById('previewEl').src = URL.createObjectURL(blob);
                        el.fileInfoDisplay.textContent = `${canvas.width} x ${canvas.height} px`;
                    }
                }, format, quality);
            };
            img.src = state.originalUrl;
        }

        async function processMediaWithFFmpeg() {
            if (!state.ffmpegLoaded) {
                el.loader.classList.remove('hidden');
                el.loaderText.textContent = "กำลังโหลดระบบจัดการสื่อ...";
                try {
                    await ffmpeg.load();
                    state.ffmpegLoaded = true;
                } catch (err) {
                    showToast('โหลดระบบไม่สำเร็จ');
                    el.loader.classList.add('hidden');
                    return;
                }
            }

            el.loader.classList.remove('hidden');
            el.progressFill.style.width = '0%';

            ffmpeg.setProgress(({ ratio }) => {
                const percent = Math.max(0, Math.min(100, Math.round(ratio * 100)));
                el.progressFill.style.width = `${percent}%`;
                el.loaderText.textContent = `กำลังแปลงไฟล์: ${percent}%`;
            });

            const inputName = 'input_' + state.file.name.replace(/\s+/g, '_');
            const targetMime = el.formatSelect.value;
            let outputExt = targetMime.split('/')[1].replace('mpeg', 'mp3');
            const outputName = `output_${Date.now()}.${outputExt}`;

            try {
                ffmpeg.FS('writeFile', inputName, await fetchFile(state.file));

                let args = ['-i', inputName];
                const bitrate = el.bitrateSelect.value;
                
                if (targetMime === 'audio/mpeg' || targetMime.startsWith('audio/')) {
                    // Audio extraction or conversion
                    if (bitrate === 'low') args.push('-ab', '128k');
                    else if (bitrate === 'medium') args.push('-ab', '192k');
                    else args.push('-ab', '320k');
                    
                    // If video to audio, disable video stream
                    if (state.file.type.startsWith('video/')) args.push('-vn');
                } else if (targetMime.startsWith('video/')) {
                    // Video conversion
                    if (bitrate === 'low') args.push('-b:v', '800k', '-crf', '30');
                    else if (bitrate === 'medium') args.push('-b:v', '2000k', '-crf', '24');
                    else args.push('-b:v', '4000k', '-crf', '18');
                }

                args.push(outputName);
                await ffmpeg.run(...args);
                
                const data = ffmpeg.FS('readFile', outputName);
                const blob = new Blob([data.buffer], { type: targetMime });
                
                el.compressedSize.textContent = formatSize(blob.size);
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `media_hub_${Date.now()}.${outputExt}`;
                link.click();
                
                showToast('สำเร็จ! เริ่มการดาวน์โหลด');
            } catch (e) {
                showToast('เกิดข้อผิดพลาดในการประมวลผล');
                console.error(e);
            } finally {
                el.loader.classList.add('hidden');
                el.progressFill.style.width = '0%';
            }
        }

        function triggerImageDownload() {
            const preview = document.getElementById('previewEl');
            const link = document.createElement('a');
            link.href = preview.src;
            const ext = el.formatSelect.value.split('/')[1];
            link.download = `compressed_${Date.now()}.${ext}`;
            link.click();
            showToast('ดาวน์โหลดรูปภาพแล้ว');
        }

        function formatSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showToast(text) {
            el.toastText.textContent = text;
            el.toast.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => { el.toast.classList.add('translate-y-20', 'opacity-0'); }, 3000);
        }

        setMode('image');
    </script>
</body>
</html>
